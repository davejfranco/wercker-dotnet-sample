build:
  box: ubuntu:latest
  steps:
        
    - internal/docker-build: 
        dockerfile: Dockerfile 
        image-name: dotnet-demo-app # name used to refer to this image until it's pushed  

    - internal/docker-push: 
        image-name: dotnet-demo-app
        username: $OCITENANT/$OCIUSER 
        password: $OCITOKEN
        registry: https://iad.ocir.io/v2
        repository: iad.ocir.io/$OCITENANT/dotnet-app
        tag: latest, ${WERCKER_GIT_BRANCH}-${WERCKER_GIT_COMMIT}

test:
  box: ubuntu:latest
  steps:

    # Test the project
    - script:
        name: Unit tests
        code: echo "TEST"    

deploy:  
  
  box:
    id: ubuntu:latest

  steps:

    - kubectl:
        server: $KUBESERVER
        insecure-skip-tls-verify: true
        token: $KUBETOKEN
        command: set image deployment/dotnet-deploy dotnet=iad.ocir.io/$OCITENANT/dotnet-app:${WERCKER_GIT_BRANCH}-${WERCKER_GIT_COMMIT}
